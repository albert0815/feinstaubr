<html>
<head>
<!-- from https://material.io/components -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript"
	src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript"
	src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<link rel="stylesheet"
	href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
<script type="text/javascript">
	var loadingStatus = new Map();
	loadingStatus.set("current", false);
	loadingStatus.set("temperature", false);
	loadingStatus.set("humidity", false);
	loadingStatus.set("p1", false);
	loadingStatus.set("p2", false);
	
	google.charts.load('current', {
		'packages' : [ 'corechart' ]
	});

	google.charts.setOnLoadCallback(drawChart);

	function drawChart() {
		$("#progressbar").css("display", "block");
		updateCurrent();
		createChart("temperature");
		createChart("humidity");
		createChart("p1");
		createChart("p2");
		setTimeout(drawChart, 60000);
	}
	$( document ).ajaxError(function( event, jqxhr, settings, thrownError ) {
		console.log(event, jqxhr, settings, thrownError);
		$("#progressbar").css("display", "none");
	});
	function checkDone() {
		var allDone = true;
		loadingStatus.forEach(function (item, key, mapObj) {  
			if (loadingStatus.get(key) == false) {
				allDone = false
			}
		});
		if (allDone) {
			$("#progressbar").css("display", "none");
		}
	}
	function updateCurrent() {
		loadingStatus["current"] = false;
		$.getJSON("rest/sensor/7620363", function(data) {
			var d = new Date(data.date); 
			$("#current_date").html(
					d.getDate() + "." + (d.getMonth() + 1) + "." + d.getFullYear() + 
					" " + 
					d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds());
			
			$("#current_temperature").html(data.temperatur + " °C");
			$("#current_humidity").html(data.humidity + " %");
			$("#current_p2").html("(P2.5) " + data.p2 + " µg/m³");
			$("#current_p1").html("(P10) " + data.p1 + " µg/m³");
			loadingStatus.set("current", true);
			checkDone();
		});
	}
	function createChart(sensorType) {
		loadingStatus[sensorType] = false;
		var labels = new Map();
		labels.set("temperature", "Temperatur in °C");
		labels.set("humidity", "Luftfeuchtigkeit in %");
		labels.set("p2", "Feinstaub PM2.5 in µg/m³");
		labels.set("p1", "Feinstaub PM10 in µg/m³");
		$.getJSON("rest/sensor/7620363/" + sensorType, function(data) {
			var dataTable = new google.visualization.DataTable();
			dataTable.addColumn('datetime', 'Time');
			dataTable.addColumn('number', labels.get(sensorType));
			var arrayLength = data.length;
			for (var i = 0; i < arrayLength; i++) {
			    data[i][0] = new Date(data[i][0]);
				dataTable.addRow(data[i])
			}
			var formatDate = new google.visualization.DateFormat({pattern: 'dd.MM.yyyy HH:mm:ss'});
			formatDate.format(dataTable, 0);
			var chart = new google.visualization.LineChart(document.getElementById(sensorType));

			var options = {
				legend : {
					position : 'none'
				},
				curveType : 'function',
				vAxis : {
					minValue : 0,
				},
				hAxis : {
					gridlines : {
						count : 6,
						color: 'none',
					},
			        format: 'HH:mm'
				}
			};

			chart.draw(dataTable, options);
			
			loadingStatus.set(sensorType, true);
			checkDone();
		});
	}
	
	$(window).resize(function() {
		drawChart();
	});
</script>
<style>
.my-bordered-list {
	/* remove the side padding. we'll be placing it around the item instead. */
	padding-right: 0;
	padding-left: 0;
}

.my-bordered-list .mdc-list-item {
	/* Add the list side padding padding to the list item. */
	padding: 0 16px;
	/* Add a border around each element. */
	border: 1px solid rgba(0, 0, 0, .12);
}
/* Ensure adjacent borders don't collide with one another. */
.my-bordered-list .mdc-list-item:not (:first-child ) {
	border-top: none;
}
</style>
</head>
<body class="mdc-typography">
	<header class="mdc-toolbar mdc-toolbar--fixed">
	  <div class="mdc-toolbar__row">
	    <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
	      <span class="mdc-toolbar__title">Hab Dich lieb</span>
	    </section>
	  </div>
	  	<div id="progressbar" role="progressbar" class="mdc-linear-progress mdc-linear-progress--indeterminate">
	  <div class="mdc-linear-progress__buffering-dots"></div>
	  <div class="mdc-linear-progress__buffer"></div>
	  <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
	    <span class="mdc-linear-progress__bar-inner"></span>
	  </div>
	  <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
	    <span class="mdc-linear-progress__bar-inner"></span>
	  </div>
	</div>				
	  
	</header>
	<main class="mdc-toolbar-fixed-adjust">
		
	<div class="mdc-layout-grid">
		<div class="mdc-layout-grid__inner">
			<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-4-mobile">
				<h3>Aktuell</h3>
				<div class="mdc-card">
				<ul class="mdc-list mdc-list--dense">
					<li class="mdc-list-item">
						<span class="mdc-list-item__graphic">
							<i class="material-icons" aria-hidden="true">access_time</i>
						</span>
						<span class="mdc-list-item__text" id="current_date">
						</span>
					</li>
					<li class="mdc-list-item">
						<span class="mdc-list-item__graphic">
							<i class="material-icons" aria-hidden="true">wb_sunny</i>
						</span>
						<span class="mdc-list-item__text" id="current_temperature"></span>
					</li>
					<li class="mdc-list-item">
						<span class="mdc-list-item__graphic">
							<i class="material-icons" aria-hidden="true">grain</i>
						</span>
						<span class="mdc-list-item__text" id="current_humidity"></span>
					</li>
					<li class="mdc-list-item">
						<span class="mdc-list-item__graphic">
							<i class="material-icons" aria-hidden="true">location_city</i>
						</span>
						<span class="mdc-list-item__text" id="current_p2"></span>
					</li>
					<li class="mdc-list-item">
						<span class="mdc-list-item__graphic">
							<i class="material-icons" aria-hidden="true">location_city</i>
						</span>
						<span class="mdc-list-item__text" id="current_p1"></span>
					</li>
				</ul>
				</div>
			</div>
		</div>
	</div>
	<div class="mdc-layout-grid">
		<div class="mdc-layout-grid__inner">
			<div class="mdc-layout-grid__cell  mdc-layout-grid__cell--span-6-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-4-mobile">
				<h3>Temperatur</h3>
				<div class="mdc-card" id="temperature">
				</div>
			</div>
			<div class="mdc-layout-grid__cell   mdc-layout-grid__cell--span-6-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-4-mobile">
				<h3>Luftfeuchtigkeit</h3>
				<div class="mdc-card" id="humidity"></div>
			</div>
			<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-4-mobile">
				<h3>P2.5</h3>
				<div class="mdc-card" id="p2"></div>
			</div>
			<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6-desktop mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-4-mobile">
				<h3>P10</h3>
				<div class="mdc-card" id="p1"></div>
			</div>
		</div>
	</div>
	</main>

	<script
		src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
	<script>
		window.mdc.autoInit();
	</script>
</body>
</html>
